angular.module('Helper.controllers', []).controller('HelperController', function($scope, $ionicPopup, $timeout, $cordovaContacts, $ionicLoading, $cordovaGeolocation, $cordovaSms, $ionicPlatform, $cordovaSQLite) {  	$ionicPlatform.on('volumeupbutton', function(){	$ionicPlatform.on('volumeupbutton', function(){		$ionicPlatform.on('volumeupbutton', function(){			$ionicPlatform.on('volumeupbutton', function(){				$ionicPlatform.on('volumeupbutton', function(){	//geoBlog	var posOptions = {        enableHighAccuracy: true,        timeout: 20000,        maximumAge: 0    };		$cordovaGeolocation.getCurrentPosition(posOptions).then(function(position){				//receive position options, create and sen SMS		var lat  = position.coords.latitude;        var long = position.coords.longitude;        console.log('lat', lat);        console.log('long', long);				$scope.sms={};		var options = {		replaceLineBreaks: false, // true to replace \n by a new line, false by default		android: {			//intent: 'INTENT'  // send SMS with the default SMS app			intent: ''        // send SMS without open any other app - background		}		};				var message = 'HELP ME PLEASE! \nMY LOCATION DATA: \nLATITUDE: ' + lat +' \nLONGITUDE: ' + long;				//select phones for sending SMS		var len = 3 ; //count of phones for SMS		$scope.phone_contact = [];		$cordovaSQLite.execute(db, "SELECT phone FROM phones ORDER BY id ASC").then(function (result) {		if (result.rows.length > 0) {			for (var i = 0; i < len; i++) {				$scope.phone_contact[i] = result.rows.item(i).phone;				$cordovaSms.send($scope.phone_contact[i], message, options).then(function() {					console.log('SUCCESS');				},function(error) {					console.log('ERROR ' + error);				});			}		}		else {console.log("No results found");}		}, function (error) {            console.log(error);        });		}, function(error){        console.log('error:', error);    });}) }) }) }) });			$scope.showAlert = function() {		var alertPopup = $ionicPopup.alert({		    title: 'Attention',			template: 'Select three contacts from your contacts directory',			buttons: [			{ 			    text: '<b>OK</b>',				type: 'button-royal'			}			]		});						alertPopup.then(function(res) {        console.log('Thank you!');		});				$timeout(function() {		alertPopup.close(); //close the popup after 7 seconds for some reason		}, 7000);		};    $scope.getContacts = function() {		//animation for loading	$ionicLoading.show({    template: '<b>Loading phonebook...</b>',	animation: 'fade-out',	showBackdrop: true,    delay: 0,    duration: 3500	});			//get phonebook with structure "name contact - main phone of contact"    $scope.phoneContacts = [];    function onSuccess(contacts) {      for (var i = 0; i < contacts.length; i++) {		if(contacts[i].phoneNumbers != null){	        var name = contacts[i].name.formatted;			var tel = contacts[i].phoneNumbers[0].value;		var contact = {nameContact: name, phone: tel};        $scope.phoneContacts.push(contact);        }	      }    };    function onError(contactError) {      alert(contactError);    };	//get selected phones + count of selected items (3 - not more, not less)	$scope.phones = { }	$scope.print = function() {    console.log($scope.phones);	}	$scope.Save = function() {    $scope.phone_sms = []; //phone_sms - array selected phones for sms	var cn = 0;	for(i in $scope.phones){	console.log($scope.phones[i]);    if($scope.phones[i] == true) {cn = cn+1;}	}		//reaction if selected less than three positions	if (cn < 3) {	var alertP = $ionicPopup.alert({		    title: 'Attention',			template: 'You have selected less than three contacts!',			buttons: [			{ 			    text: '<b>OK</b>',				type: 'button-royal'			}			]	}); 		alertP.then(function(res) {    console.log('OK');	});			$timeout(function() {	alertP.close();	}, 7000);	}			//reaction if selected more than three positions	if (cn > 3) {	var alertP = $ionicPopup.alert({		    title: 'Attention',			template: 'You have selected more than three contacts!',			buttons: [			{ 			    text: '<b>OK</b>',				type: 'button-royal'			}			]	}); 		alertP.then(function(res) {    console.log('OK');	});			$timeout(function() {	alertP.close();	}, 7000);	}		//reaction if selected exactly three positions	if (cn == 3){    for(i in $scope.phones) {        console.log($scope.phones[i]);        if($scope.phones[i] == true) {            $scope.phone_sms.push(i);        }    }		if ($scope.phone_sms!=null){	var alertP = $ionicPopup.alert({		    title: 'Congratulations',			template: 'Your selected three phone numbers (' + $scope.phone_sms + ') to send them an SMS asking for help, saved.\nLater, in case of a difficult situation to send on the above message numbers, press the volumedownbutton.',			buttons: [			{ 			    text: '<b>OK</b>',				type: 'button-royal',				//onTap: function() { ionicPlatform.exitApp(); }			}			]		}); 			alertP.then(function(res) {		console.log('OK');		});				$timeout(function() {		alertP.close();		}, 9000);		//insert phones into database	for(i in $scope.phone_sms){		$cordovaSQLite.execute(db, 'INSERT OR REPLACE INTO phones (phone) VALUES (?)', [$scope.phone_sms[i]])            .then(function(result) {                console.log('SUCCESS');            }, function(error) {                console.log('ERROR');        });		};	};	};	};	    var options = {};    options.multiple = true;    $cordovaContacts.find(options).then(onSuccess, onError);  };	});